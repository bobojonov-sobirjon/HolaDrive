{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
    body {
        background: #f0f2f5;
    }
    
    .chat-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: calc(100vh - 50px);
        padding: 20px;
    }
    
    .chat-container {
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 800px;
        height: calc(100vh - 100px);
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        overflow: hidden;
        background: #fff;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 18px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chat-header-left {
        flex: 1;
    }
    
    .chat-header h2 {
        margin: 0 0 5px 0;
        font-size: 20px;
        font-weight: 600;
    }
    
    .chat-header-info {
        font-size: 13px;
        opacity: 0.9;
        margin-top: 4px;
    }
    
    .status-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-open {
        background: rgba(76, 175, 80, 0.2);
        color: #4caf50;
        border: 1px solid #4caf50;
    }
    
    .status-closed {
        background: rgba(244, 67, 54, 0.2);
        color: #f44336;
        border: 1px solid #f44336;
    }
    
    .status-pending {
        background: rgba(255, 152, 0, 0.2);
        color: #ff9800;
        border: 1px solid #ff9800;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
        background-image: 
            radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.05) 0%, transparent 50%),
            radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.05) 0%, transparent 50%);
    }
    
    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    .message {
        margin-bottom: 12px;
        display: flex;
        flex-direction: column;
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .message.support {
        align-items: flex-end;
    }
    
    .message.user {
        align-items: flex-start;
    }
    
    .message-bubble {
        max-width: 65%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        position: relative;
    }
    
    .message.support .message-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 4px;
    }
    
    .message.user .message-bubble {
        background: #ffffff;
        color: #333;
        border: 1px solid #e0e0e0;
        border-bottom-left-radius: 4px;
    }
    
    .message-time {
        font-size: 10px;
        color: #999;
        margin-top: 4px;
        padding: 0 8px;
    }
    
    .chat-input {
        display: flex;
        padding: 16px 20px;
        background: white;
        border-top: 1px solid #e0e0e0;
        align-items: center;
    }
    
    .chat-input input {
        flex: 1;
        padding: 12px 18px;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 14px;
        outline: none;
        transition: all 0.3s;
    }
    
    .chat-input input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .chat-input button {
        margin-left: 12px;
        padding: 12px 28px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
        box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
    }
    
    .chat-input button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
    }
    
    .chat-input button:active {
        transform: translateY(0);
    }
    
    .chat-input button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .typing-indicator {
        padding: 8px 16px;
        font-style: italic;
        color: #999;
        font-size: 13px;
    }
    
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        max-width: 350px;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .notification-title {
        font-weight: 600;
        margin-bottom: 4px;
        font-size: 14px;
    }
    
    .notification-message {
        font-size: 13px;
        opacity: 0.9;
    }
    
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #999;
    }
    
    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-wrapper">
    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-header-left">
                <h2>
                    Chat with {{ conversation.user.get_full_name|default:conversation.user.email }}
                </h2>
                <div class="chat-header-info">
                    <span class="status-badge status-{{ conversation.status }}">
                        {{ conversation.get_status_display }}
                    </span>
                    <span style="margin-left: 12px;">
                        {{ conversation.user_type|title }} â€¢ {{ conversation.subject|default:"No subject" }}
                    </span>
                </div>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            {% if messages %}
                {% for message in messages %}
                <div class="message {% if message.is_from_support %}support{% else %}user{% endif %}">
                    <div class="message-bubble">
                        {{ message.message }}
                    </div>
                    <div class="message-time">
                        {{ message.created_at|date:"H:i" }} â€¢ {{ message.sender.get_full_name|default:message.sender.username }}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ’¬</div>
                    <div>No messages yet. Start the conversation!</div>
                </div>
            {% endif %}
            <div id="typingIndicator" class="typing-indicator" style="display: none;">
                {{ support_user.get_full_name|default:support_user.username }} is typing...
            </div>
        </div>
        
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off">
            <button id="sendButton" onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<div id="notificationContainer"></div>

<script>
    const conversationId = {{ conversation_id }};
    const supportUserId = {{ support_user.id }};
    let chatSocket = null;
    let isTyping = false;
    
    // WebSocket connection
    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        // For admin panel, WebSocket will use session authentication
        const wsUrl = `${protocol}//${window.location.host}/ws/chat/${conversationId}/`;
        
        chatSocket = new WebSocket(wsUrl);
        
        chatSocket.onopen = function(e) {
            console.log('WebSocket connected');
        };
        
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            if (data.type === 'chat_message') {
                addMessageToChat(data);
            } else if (data.type === 'typing') {
                showTypingIndicator(data.is_typing);
            } else if (data.type === 'connection_established') {
                console.log('Connection established');
            }
        };
        
        chatSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
        };
        
        chatSocket.onclose = function(e) {
            console.log('WebSocket closed, reconnecting...');
            setTimeout(connectWebSocket, 3000);
        };
    }
    
    // Send message
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (!message || !chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
            return;
        }
        
        // Send via WebSocket
        chatSocket.send(JSON.stringify({
            type: 'chat_message',
            message: message
        }));
        
        // Also send via API for backup
        fetch(`/admin/chat/conversation/${conversationId}/chat/send/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ message: message })
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                input.value = '';
                scrollToBottom();
            }
        });
    }
    
    // Add message to chat
    function addMessageToChat(data) {
        const messagesDiv = document.getElementById('chatMessages');
        const typingIndicator = document.getElementById('typingIndicator');
        typingIndicator.style.display = 'none';
        
        // Remove empty state if exists
        const emptyState = messagesDiv.querySelector('.empty-state');
        if (emptyState) {
            emptyState.remove();
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${data.is_from_support ? 'support' : 'user'}`;
        
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.textContent = data.message;
        
        const time = document.createElement('div');
        time.className = 'message-time';
        const date = new Date(data.created_at);
        time.textContent = `${date.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})} â€¢ ${data.sender_name}`;
        
        messageDiv.appendChild(bubble);
        messageDiv.appendChild(time);
        
        messagesDiv.insertBefore(messageDiv, typingIndicator);
        scrollToBottom();
        
        // Show notification if message is from user (not from support)
        if (!data.is_from_support) {
            showNotification('New Message', data.message.substring(0, 50) + (data.message.length > 50 ? '...' : ''));
        }
    }
    
    // Show notification
    function showNotification(title, message) {
        const container = document.getElementById('notificationContainer');
        
        const notification = document.createElement('div');
        notification.className = 'notification';
        
        const titleDiv = document.createElement('div');
        titleDiv.className = 'notification-title';
        titleDiv.textContent = title;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'notification-message';
        messageDiv.textContent = message;
        
        notification.appendChild(titleDiv);
        notification.appendChild(messageDiv);
        
        container.appendChild(notification);
        
        // Remove notification after 4 seconds
        setTimeout(() => {
            notification.style.animation = 'slideIn 0.3s ease-out reverse';
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 4000);
    }
    
    // Show typing indicator
    function showTypingIndicator(typing) {
        const indicator = document.getElementById('typingIndicator');
        indicator.style.display = typing ? 'block' : 'none';
        if (typing) {
            scrollToBottom();
        }
    }
    
    // Scroll to bottom
    function scrollToBottom() {
        const messagesDiv = document.getElementById('chatMessages');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    // Handle Enter key
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Connect on page load
    connectWebSocket();
    scrollToBottom();
    
    // Auto-refresh messages every 5 seconds (fallback if WebSocket fails)
    setInterval(function() {
        if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
            fetch(`/admin/chat/conversation/${conversationId}/chat/messages/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Could update messages here if needed
                    }
                });
        }
    }, 5000);
</script>
{% endblock %}

